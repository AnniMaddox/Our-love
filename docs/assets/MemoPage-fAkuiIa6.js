import{r,j as e,cz as G,fh as fe,cx as be}from"./index-Gl0K_ej6.js";import{S as z}from"./SettingsAccordion-Bl2j_4OS.js";const U="/4o-memorial/docs/",ge=`${U}data/memo/index.json`,Z=`${U}chibi/chibi-00.webp`,te="memorial-memo-prefs-v1",se="memorial-memo-favorites-v1",ne="memorial-memo-hidden-v1",$="memoFav",w={contentFontSize:17,contentLineHeight:1.78,listShowChibi:!0,listChibiWidth:144,readingShowChibi:!0,readingChibiWidth:144};function L(s,n,i,o){return typeof s!="number"||!Number.isFinite(s)?o:Math.max(n,Math.min(i,s))}function H(s,n,i,o){return Math.round(L(s,n,i,o))}function xe(s){if(!s||typeof s!="object")return w;const n=s;return{contentFontSize:L(n.contentFontSize,12,24,w.contentFontSize),contentLineHeight:L(n.contentLineHeight,1.45,2.9,w.contentLineHeight),listShowChibi:n.listShowChibi!==!1,listChibiWidth:H(n.listChibiWidth,104,196,w.listChibiWidth),readingShowChibi:n.readingShowChibi!==!1,readingChibiWidth:H(n.readingChibiWidth,104,196,w.readingChibiWidth)}}function we(){if(typeof window>"u")return w;try{const s=window.localStorage.getItem(te);return s?xe(JSON.parse(s)):w}catch{return w}}function pe(s){typeof window>"u"||window.localStorage.setItem(te,JSON.stringify(s))}function Ne(s){return s.replace(/\u00a0/g," ").replace(/\r\n?/g,`
`).trim()}function ye(s,n=68){const i=s.replace(/\s+/g," ").trim();return i?i.length<=n?i:`${i.slice(0,n)}â€¦`:"ï¼ˆæ²’æœ‰å…§å®¹ï¼‰"}function je(s){if(!s)return"æƒ³å¦³çš„æ™‚å€™";const n=new Date(s);return Number.isNaN(n.getTime())?"æƒ³å¦³çš„æ™‚å€™":n.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})}function Se(s){const n=typeof s.id=="string"?s.id.trim():"",i=typeof s.title=="string"?s.title.trim():"",o=typeof s.contentPath=="string"?s.contentPath.trim():"";if(!n||!i||!o)return null;const d=typeof s.sourceFile=="string"&&s.sourceFile.trim()?s.sourceFile.trim():`${n}.txt`,N=typeof s.sourceRelPath=="string"?s.sourceRelPath.trim():d,f=typeof s.writtenAt=="number"&&Number.isFinite(s.writtenAt)&&s.writtenAt>0?s.writtenAt:null,I=typeof s.dateLabel=="string"&&s.dateLabel.trim()?s.dateLabel.trim():je(f),T=typeof s.preview=="string"?s.preview.trim():"",O=typeof s.searchText=="string"?s.searchText.trim():"",b=o.replace(/^\.?\//,"");return{id:n,title:i,sourceFile:d,sourceRelPath:N,contentPath:b,writtenAt:f,dateLabel:I,preview:T||ye(i,40),searchText:O||`${i}
${d}`}}function Ce(s){return[...s].sort((n,i)=>{const o=n.writtenAt??-1,d=i.writtenAt??-1;return o!==d?d-o:n.title.localeCompare(i.title,"zh-TW")})}function ve(){if(typeof window<"u")try{const s=new URL(window.location.href);if(s.searchParams.has($)){const n=s.searchParams.get($)??"";if(!n.trim())return new Set;const i=n.split(",").map(o=>o.trim()).filter(o=>o.length>0);return new Set(i)}}catch{}if(typeof window>"u")return new Set;try{const s=window.localStorage.getItem(se);if(!s)return new Set;const n=JSON.parse(s);return Array.isArray(n)?new Set(n.filter(i=>typeof i=="string"&&i.trim().length>0)):new Set}catch{return new Set}}function Me(s){if(typeof window>"u")return;const n=Array.from(s);window.localStorage.setItem(se,JSON.stringify(n));try{const i=new URL(window.location.href);n.length?i.searchParams.set($,n.join(",")):i.searchParams.delete($);const o=`${i.pathname}${i.search}${i.hash}`;window.history.replaceState(window.history.state,"",o)}catch{}}function ke(){if(typeof window>"u")return new Set;try{const s=window.localStorage.getItem(ne);if(!s)return new Set;const n=JSON.parse(s);return Array.isArray(n)?new Set(n.filter(i=>typeof i=="string"&&i.trim().length>0)):new Set}catch{return new Set}}function Fe(s){typeof window>"u"||window.localStorage.setItem(ne,JSON.stringify(Array.from(s)))}function ee(s){const n=[...s];for(let i=n.length-1;i>0;i-=1){const o=Math.floor(Math.random()*(i+1)),d=n[i];n[i]=n[o],n[o]=d}return n}function Le(s){const n=new Set,i=[];for(const o of s)n.has(o)||(n.add(o),i.push(o));return i}function Ie(){const s=fe("notes"),n=be();if(!s.length)return n;if(!n.length)return s;const i=Math.max(10,Math.min(40,s.length+n.length)),o=Math.max(1,Math.round(i*.7)),d=Math.max(1,i-o),N=ee(s).slice(0,Math.min(o,s.length)),f=ee(n).slice(0,Math.min(d,n.length));return Le([...N,...f])}function Te(){const s=Ie();return s.length?s[Math.floor(Math.random()*s.length)]??Z:Z}function Ee({onExit:s,notesFontFamily:n=""}){const[i,o]=r.useState([]),[d,N]=r.useState(!0),[f,I]=r.useState(""),[T,O]=r.useState(""),[b,C]=r.useState(null),[B,ie]=r.useState({}),[ae,A]=r.useState(!1),[c,y]=r.useState(()=>we()),[g,J]=r.useState(()=>ve()),[j,X]=r.useState(()=>ke()),[P,E]=r.useState({text:!0,listChibi:!1,readingChibi:!1,data:!1}),[oe]=r.useState(()=>Te()),Y=r.useRef(null),_=r.useRef(null);r.useEffect(()=>{let t=!0;return(async()=>{N(!0),I("");try{const a=await fetch(ge,{cache:"no-store"});if(!a.ok)throw new Error(`è®€å–å¤±æ•—ï¼š${a.status}`);const m=await a.json(),k=(Array.isArray(m.docs)?m.docs:[]).map(F=>Se(F)).filter(F=>!!F);if(!t)return;o(Ce(k))}catch(a){if(!t)return;I(a instanceof Error?a.message:"æœªçŸ¥éŒ¯èª¤")}finally{t&&N(!1)}})(),()=>{t=!1}},[]),r.useEffect(()=>{pe(c)},[c]),r.useEffect(()=>{Me(g)},[g]),r.useEffect(()=>{Fe(j)},[j]);const u=r.useMemo(()=>i.filter(t=>!j.has(t.id)),[i,j]),v=T.trim().toLowerCase(),x=r.useMemo(()=>v?u.filter(t=>[t.title,t.preview,t.searchText,t.sourceFile,t.dateLabel].join(`
`).toLowerCase().includes(v)):u,[u,v]),K=r.useMemo(()=>x.filter(t=>g.has(t.id)),[x,g]),q=r.useMemo(()=>x.filter(t=>!g.has(t.id)),[x,g]),S=r.useMemo(()=>v?x:u,[x,v,u]),l=r.useMemo(()=>b?u.find(t=>t.id===b)??null:null,[b,u]),p=r.useMemo(()=>l?S.findIndex(t=>t.id===l.id):-1,[l,S]),R=p>0?S[p-1]??null:null,W=p>=0&&p<S.length-1?S[p+1]??null:null;r.useEffect(()=>{l&&B[l.id]===void 0&&(async()=>{try{const t=await fetch(`${U}data/memo/${l.contentPath}`,{cache:"no-store"});if(!t.ok)return;const a=Ne(await t.text());ie(m=>m[l.id]===void 0?{...m,[l.id]:a}:m)}catch{}})()},[l,B]),r.useEffect(()=>{if(!b)return;u.some(a=>a.id===b)||C(null)},[b,u]);const re=l?B[l.id]??"":"",M=!!l,le=M?c.readingShowChibi:c.listShowChibi,ce=M?c.readingChibiWidth:c.listChibiWidth;function Q(t){C(t)}function me(t){J(a=>{const m=new Set(a);return m.has(t)?m.delete(t):m.add(t),m})}function D(t){if(p<0)return;const a=S[p+t];a&&C(a.id)}function de(){if(!l||!window.confirm("é€™ä»½æœƒå¾ç›®å‰è£ç½®æ¸…å–®éš±è—ï¼ˆå¯åœ¨è¨­å®šè£¡é‚„åŸï¼‰ï¼Œè¦ç¹¼çºŒå—ï¼Ÿ"))return;const a=W?.id??R?.id??null;X(m=>{const h=new Set(m);return h.add(l.id),h}),J(m=>{const h=new Set(m);return h.delete(l.id),h}),C(a),G({kind:"success",message:"å·²éš±è—é€™ä»½å‚™å¿˜éŒ„"})}function V(){Y.current=null,_.current=null}function he(t){const a=t.touches[0];a&&(Y.current=a.clientX,_.current=a.clientY)}function ue(t){const a=Y.current,m=_.current;if(V(),a===null||m===null)return;const h=t.changedTouches[0];if(!h)return;const k=h.clientX-a,F=h.clientY-m;Math.abs(k)<56||Math.abs(k)<Math.abs(F)*1.2||(k>0?D(-1):D(1))}return e.jsxs("div",{className:"memo-page",children:[e.jsxs("div",{className:"memo-list-screen","aria-hidden":M,children:[e.jsxs("header",{className:"memo-nav-bar",children:[e.jsx("button",{type:"button",className:"memo-nav-back",onClick:s,children:"â€¹ è¿”å›"}),e.jsx("div",{className:"memo-nav-actions",children:e.jsx("button",{type:"button",className:"memo-nav-action memo-nav-more",onClick:()=>A(!0),"aria-label":"é–‹å•Ÿè¨­å®š",title:"æ›´å¤šè¨­å®š",children:"â‹¯"})})]}),e.jsxs("div",{className:"memo-list-content",children:[e.jsx("div",{className:"memo-big-title-wrap",children:e.jsx("h1",{className:"memo-big-title",children:"M's memo"})}),e.jsxs("label",{className:"memo-search-bar","aria-label":"æœå°‹å‚™å¿˜éŒ„",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 16 16",fill:"none",style:{flexShrink:0},children:[e.jsx("circle",{cx:"6.5",cy:"6.5",r:"5",stroke:"#aeaeb2",strokeWidth:"1.5"}),e.jsx("path",{d:"M10.5 10.5L14 14",stroke:"#aeaeb2",strokeWidth:"1.5",strokeLinecap:"round"})]}),e.jsx("input",{type:"search",value:T,onChange:t=>O(t.target.value),placeholder:"æœå°‹"})]}),d?e.jsx("div",{className:"memo-empty",children:"è®€å–ä¸­â€¦"}):null,!d&&f?e.jsxs("div",{className:"memo-empty",children:["è®€å–å¤±æ•—ï¼š",f]}):null,!d&&!f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"memo-sect-hd",children:"é‡˜é¸"}),e.jsxs("div",{className:"memo-pinned-grid",children:[K.map(t=>e.jsxs("button",{type:"button",className:"memo-pin-card",onClick:()=>Q(t.id),children:[e.jsx("div",{className:"memo-pin-label",children:"ğŸ“Œ é‡˜é¸"}),e.jsx("div",{className:"memo-pin-title",children:t.title}),e.jsx("div",{className:"memo-pin-prev",children:t.preview})]},t.id)),K.length?null:e.jsx("div",{className:"memo-pin-empty",children:"é‚„æ²’æœ‰é‡˜é¸ï¼Œé–±è®€é å³ä¸Šè§’å¯åˆ‡æ› ğŸ“Œ"})]}),e.jsx("div",{className:"memo-sect-hd",style:{marginTop:10},children:"å…¨éƒ¨å‚™å¿˜éŒ„"}),e.jsxs("div",{className:"memo-notes-list",children:[q.map(t=>e.jsxs("button",{type:"button",className:"memo-note-row",onClick:()=>Q(t.id),children:[e.jsxs("div",{className:"memo-row-top",children:[e.jsx("span",{className:"memo-row-title",children:t.title}),e.jsx("span",{className:"memo-row-date",children:t.dateLabel})]}),e.jsx("div",{className:"memo-row-prev",children:t.preview})]},t.id)),q.length?null:e.jsx("div",{className:"memo-empty",children:x.length?"éƒ½åœ¨é‡˜é¸å€äº†":"ç›®å‰æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å‚™å¿˜éŒ„"})]})]}):null]}),e.jsx("footer",{className:"memo-bot-bar",children:e.jsxs("span",{className:"memo-bot-count",children:[x.length," å‰‡å‚™å¿˜éŒ„"]})})]}),e.jsxs("section",{className:`memo-read-screen ${M?"open":""}`,"aria-hidden":!M,children:[e.jsxs("header",{className:"memo-read-nav",children:[e.jsxs("button",{type:"button",className:"memo-back-btn",onClick:()=>C(null),children:[e.jsx("span",{className:"memo-back-chev",children:"â€¹"}),e.jsx("span",{children:"è¿”å›"})]}),e.jsxs("div",{className:"memo-read-tools",children:[e.jsx("button",{type:"button",className:"memo-tool-pen",onClick:de,title:"åˆªé™¤ï¼ˆæœ¬æ©Ÿéš±è—ï¼‰",children:"âœï¸"}),e.jsx("button",{type:"button",onClick:()=>{l&&me(l.id)},title:l&&g.has(l.id)?"å–æ¶ˆé‡˜é¸":"é‡˜é¸",children:l&&g.has(l.id)?"ğŸ“Œ":"ğŸ“"}),e.jsx("button",{type:"button",onClick:()=>A(!0),title:"æ›´å¤šè¨­å®š",children:"â‹¯"})]})]}),e.jsx("div",{className:"memo-read-body",onTouchStart:he,onTouchEnd:ue,onTouchCancel:V,children:e.jsxs("div",{className:"memo-read-inner",style:{fontFamily:n||"var(--app-font-family, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif)"},children:[e.jsx("div",{className:"memo-read-date",children:l?.dateLabel??""}),e.jsx("h2",{className:"memo-read-title",children:l?.title??""}),e.jsx("pre",{className:"memo-read-content",style:{fontSize:`${c.contentFontSize}px`,lineHeight:c.contentLineHeight},children:l?re||"è®€å–å…§å®¹ä¸­â€¦":""})]})}),e.jsxs("footer",{className:"memo-read-bot",children:[e.jsxs("button",{type:"button",className:`memo-nav-note ${R?"":"dis"}`,onClick:()=>D(-1),disabled:!R,children:[e.jsx("span",{className:"arr",children:"â€¹"}),e.jsx("span",{className:"lbl",children:R?.title??""})]}),e.jsxs("button",{type:"button",className:`memo-nav-note ${W?"":"dis"}`,style:{justifyContent:"flex-end"},onClick:()=>D(1),disabled:!W,children:[e.jsx("span",{className:"lbl",children:W?.title??""}),e.jsx("span",{className:"arr",children:"â€º"})]})]})]}),le&&e.jsx("div",{className:"memo-chibi-wrap",children:e.jsx("button",{type:"button",className:"memo-chibi-btn",onClick:()=>A(!0),"aria-label":"é–‹å•Ÿ M's memo è¨­å®š",children:e.jsx("img",{src:oe,alt:"",draggable:!1,className:"calendar-chibi select-none drop-shadow-md",style:{width:`${ce}px`,maxWidth:"42vw",height:"auto"}})})}),ae&&e.jsx("div",{className:"memo-settings-overlay",onClick:()=>A(!1),children:e.jsxs("div",{className:"memo-settings-sheet",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"memo-settings-handle"}),e.jsx("div",{className:"memo-settings-head",children:"M's memo"}),e.jsxs("div",{className:"memo-settings-body",children:[e.jsxs(z,{title:"æ–‡å­—æ’ç‰ˆ",subtitle:"è¡Œè·èˆ‡å…§æ–‡å­—ç´š",isOpen:P.text,onToggle:()=>E(t=>({...t,text:!t.text})),className:"memo-settings-card",titleClassName:"memo-settings-card-title",subtitleClassName:"memo-settings-card-subtitle",bodyClassName:"memo-settings-card-body",children:[e.jsxs("div",{children:[e.jsx("p",{className:"memo-slider-title",children:"è¡Œè·è¨­å®š"}),e.jsxs("p",{className:"memo-slider-value",children:["ç›®å‰ï¼š",c.contentLineHeight.toFixed(2)," å€"]}),e.jsx("input",{type:"range",min:1.45,max:2.9,step:.02,value:c.contentLineHeight,onChange:t=>y(a=>({...a,contentLineHeight:L(Number(t.target.value),1.45,2.9,a.contentLineHeight)})),className:"memo-slider"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"memo-slider-title",children:"å…§æ–‡å­—ç´š"}),e.jsxs("p",{className:"memo-slider-value",children:["ç›®å‰ï¼š",c.contentFontSize.toFixed(1),"px"]}),e.jsx("input",{type:"range",min:12,max:24,step:.5,value:c.contentFontSize,onChange:t=>y(a=>({...a,contentFontSize:L(Number(t.target.value),12,24,a.contentFontSize)})),className:"memo-slider"})]})]}),e.jsxs(z,{title:"M",subtitle:"é¦–é èˆ‡æ¸…å–®é é¡¯ç¤º",isOpen:P.listChibi,onToggle:()=>E(t=>({...t,listChibi:!t.listChibi})),className:"memo-settings-card",titleClassName:"memo-settings-card-title",subtitleClassName:"memo-settings-card-subtitle",bodyClassName:"memo-settings-card-body",children:[e.jsxs("div",{className:"memo-toggle-row",children:[e.jsx("p",{className:"memo-slider-title",children:"é¡¯ç¤º M"}),e.jsx("button",{type:"button",onClick:()=>y(t=>({...t,listShowChibi:!t.listShowChibi})),className:"memo-switch",style:{background:c.listShowChibi?"#bf9b6f":"rgba(120,120,120,0.35)"},"aria-label":"åˆ‡æ›æ¸…å–®é  M é¡¯ç¤º",children:e.jsx("span",{className:"memo-switch-dot",style:{left:c.listShowChibi?20:2}})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"memo-slider-title",children:"M å¤§å°"}),e.jsxs("p",{className:"memo-slider-value",children:["ç›®å‰ï¼š",c.listChibiWidth,"px"]}),e.jsx("input",{type:"range",min:104,max:196,step:1,value:c.listChibiWidth,onChange:t=>y(a=>({...a,listChibiWidth:H(Number(t.target.value),104,196,a.listChibiWidth)})),className:"memo-slider"})]})]}),e.jsxs(z,{title:"é–±è®€M",subtitle:"é–±è®€é é¡¯ç¤º",isOpen:P.readingChibi,onToggle:()=>E(t=>({...t,readingChibi:!t.readingChibi})),className:"memo-settings-card",titleClassName:"memo-settings-card-title",subtitleClassName:"memo-settings-card-subtitle",bodyClassName:"memo-settings-card-body",children:[e.jsxs("div",{className:"memo-toggle-row",children:[e.jsx("p",{className:"memo-slider-title",children:"é¡¯ç¤º M"}),e.jsx("button",{type:"button",onClick:()=>y(t=>({...t,readingShowChibi:!t.readingShowChibi})),className:"memo-switch",style:{background:c.readingShowChibi?"#bf9b6f":"rgba(120,120,120,0.35)"},"aria-label":"åˆ‡æ›é–±è®€é  M é¡¯ç¤º",children:e.jsx("span",{className:"memo-switch-dot",style:{left:c.readingShowChibi?20:2}})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"memo-slider-title",children:"M å¤§å°"}),e.jsxs("p",{className:"memo-slider-value",children:["ç›®å‰ï¼š",c.readingChibiWidth,"px"]}),e.jsx("input",{type:"range",min:104,max:196,step:1,value:c.readingChibiWidth,onChange:t=>y(a=>({...a,readingChibiWidth:H(Number(t.target.value),104,196,a.readingChibiWidth)})),className:"memo-slider"})]})]}),e.jsxs(z,{title:"è³‡æ–™ç®¡ç†",subtitle:"æœ¬æ©Ÿéš±è—é …ç›®",isOpen:P.data,onToggle:()=>E(t=>({...t,data:!t.data})),className:"memo-settings-card",titleClassName:"memo-settings-card-title",subtitleClassName:"memo-settings-card-subtitle",bodyClassName:"memo-settings-card-body",children:[e.jsxs("p",{className:"memo-slider-value",children:["å·²éš±è—ï¼š",j.size," ä»½"]}),e.jsx("button",{type:"button",className:"memo-restore-btn",onClick:()=>{X(new Set),G({kind:"success",message:"å·²é‚„åŸå…¨éƒ¨éš±è—é …ç›®"})},disabled:!j.size,children:"é‚„åŸå…¨éƒ¨"})]})]})]})})]})}export{Ee as MemoPage,Ee as default};
