import{r as i,j as e}from"./index-CDzCU3ys.js";const D="/Our-love/docs/",O=`${D}data/murmur/index.json`,V="/data/murmur/index.json",T="memorial-murmur-avatar-v1",S="M";function q(r){const c=(r||"/").trim();if(!c)return"/";const s=c.startsWith("/")?c:`/${c}`;return s.endsWith("/")?s:`${s}/`}function M(r,c){const s=q(r),h=c.replace(/^\/+/,"");return`${s}${h}`}async function _(r,c){const s={cache:"no-store"};try{const h=await fetch(r,s);if(h.ok||r===c)return h;const f=await fetch(c,s);return f.ok?f:h}catch{if(r===c)throw new Error("NETWORK_FETCH_FAILED");return fetch(c,s)}}function J(){if(typeof window>"u")return"";try{const r=window.localStorage.getItem(T);return typeof r=="string"?r.trim():""}catch{return""}}function Q(r){if(!(typeof window>"u"))try{r?window.localStorage.setItem(T,r):window.localStorage.removeItem(T)}catch{}}function ee({onExit:r,notesFontFamily:c=""}){const[s,h]=i.useState([]),[f,k]=i.useState(!0),[j,C]=i.useState(""),[I,y]=i.useState(null),[w,L]=i.useState({}),[m,P]=i.useState(()=>J()),$=i.useRef(null),g=i.useRef(null),A=i.useRef(null);i.useEffect(()=>{Q(m)},[m]),i.useEffect(()=>{let t=!1;async function n(){k(!0),C("");try{const a=await _(O,V);if(!a.ok)throw new Error(`HTTP ${a.status}`);const l=await a.json(),u=Array.isArray(l.docs)?l.docs:[];t||h([...u].sort((x,p)=>{const N=typeof x.order=="number"?x.order:Number.MAX_SAFE_INTEGER,v=typeof p.order=="number"?p.order:Number.MAX_SAFE_INTEGER;return N!==v?N-v:x.title.localeCompare(p.title,"zh-TW")}))}catch(a){t||C(a instanceof Error?a.message:"未知錯誤")}finally{t||k(!1)}}return n(),()=>{t=!0}},[]);const o=i.useMemo(()=>s.findIndex(t=>t.id===I),[s,I]),d=o>=0?s[o]:null,E=o>0?s[o-1]:null,R=o>=0&&o<s.length-1?s[o+1]:null;i.useEffect(()=>{const t=d?.id,n=d?.contentPath;if(!t||!n)return;const a=t,l=n;if(w[a]!==void 0)return;let u=!1;async function x(){try{const p=M(D,`data/murmur/${l}`),N=M("/",`data/murmur/${l}`),v=await _(p,N);if(!v.ok)throw new Error(`HTTP ${v.status}`);const G=await v.text();u||L(H=>({...H,[a]:G.trim()}))}catch{u||L(p=>({...p,[a]:"讀取內容失敗，請稍後再試。"}))}}return x(),()=>{u=!0}},[d,w]);const X=i.useMemo(()=>`碎碎念 · ${s.length} 則`,[s.length]);function B(t){y(t)}function F(){y(null)}function b(t){if(o<0)return;const n=s[o+t];n&&y(n.id)}function W(){$.current?.click()}function Y(){g.current=null,A.current=null}function z(t){const n=t.touches[0];n&&(g.current=n.clientX,A.current=n.clientY)}function K(t){const n=g.current,a=A.current;if(Y(),n===null||a===null)return;const l=t.changedTouches[0];if(!l)return;const u=l.clientX-n,x=l.clientY-a;Math.abs(u)<56||Math.abs(u)<Math.abs(x)*1.2||(u>0?b(-1):b(1))}function U(t){const n=t.target.files?.[0];if(t.target.value="",!n)return;if(!n.type.startsWith("image/")){window.alert("請選擇圖片檔案");return}const a=new FileReader;a.onload=()=>{const l=typeof a.result=="string"?a.result:"";l&&P(l)},a.readAsDataURL(n)}return e.jsxs("div",{className:"murmur-page",style:{"--murmur-font-family":c?`'${c}', sans-serif`:""},children:[e.jsx("input",{ref:$,type:"file",accept:"image/*",className:"murmur-avatar-input",onChange:U}),e.jsxs("header",{className:"chat-header",children:[e.jsx("button",{type:"button",className:"hd-back",onClick:r,"aria-label":"返回",children:"‹"}),e.jsxs("div",{className:"contact-wrap",children:[e.jsx("button",{type:"button",className:"contact-avatar",onClick:W,"aria-label":"更換頭像",children:m?e.jsx("img",{src:m,alt:"M avatar"}):e.jsx("span",{children:S})}),e.jsx("div",{className:"contact-sub",children:X})]}),e.jsx("span",{className:"hd-side-spacer","aria-hidden":"true"})]}),e.jsxs("main",{className:"chat-body",children:[f?e.jsx("div",{className:"murmur-empty",children:"讀取中…"}):null,!f&&j?e.jsxs("div",{className:"murmur-empty",children:["讀取失敗：",j]}):null,!f&&!j&&!s.length?e.jsx("div",{className:"murmur-empty",children:"目前沒有碎碎念"}):null,!f&&!j?s.map(t=>e.jsxs("div",{children:[e.jsx("div",{className:"time-divider",children:t.timeLabel}),e.jsxs("div",{className:"msg-row",children:[e.jsx("div",{className:"msg-avatar",children:m?e.jsx("img",{src:m,alt:"M avatar"}):e.jsx("span",{children:S})}),e.jsxs("button",{type:"button",className:"bubble",onClick:()=>B(t.id),children:[e.jsx("div",{className:"bubble-text",children:t.preview}),e.jsx("div",{className:"bubble-hint",children:"▾ 展開閱讀"}),e.jsx("div",{className:"bubble-read",children:"已讀"})]})]})]},t.id)):null]}),e.jsx("footer",{className:"chat-bottom",children:e.jsx("div",{className:"input-mock",children:"有什麼想回覆他的嗎..."})}),e.jsxs("section",{id:"readScreen",className:d?"open":"","aria-hidden":!d,children:[e.jsxs("div",{className:"rs-nav",children:[e.jsxs("button",{type:"button",className:"rs-back",onClick:F,children:[e.jsx("span",{className:"rs-back-chev",children:"‹"}),e.jsx("span",{children:"碎碎念"})]}),e.jsx("span",{className:"rs-time-label",children:d?.timeLabel??""})]}),e.jsxs("div",{className:"rs-sender",children:[e.jsx("div",{className:"rs-avatar",children:m?e.jsx("img",{src:m,alt:"M avatar"}):e.jsx("span",{children:S})}),e.jsxs("div",{className:"rs-sender-info",children:[e.jsx("div",{className:"rs-sender-name"}),e.jsxs("div",{className:"rs-sender-sub",children:["傳送於 ",e.jsx("span",{children:d?.timeLabel??""})]})]})]}),e.jsx("div",{className:"rs-body",onTouchStart:z,onTouchEnd:K,children:e.jsx("div",{className:"rs-inner",children:e.jsx("div",{className:"rs-content",children:d?w[d.id]??"讀取中…":""})})}),e.jsxs("div",{className:"rs-bot",children:[e.jsxs("button",{type:"button",className:`rs-nav-btn ${E?"":"dis"}`,onClick:()=>b(-1),disabled:!E,children:[e.jsx("span",{className:"arr",children:"‹"}),e.jsx("span",{className:"lbl",children:E?.timeLabel??""})]}),e.jsx("span",{className:"rs-pos",children:d?`${o+1} / ${s.length}`:""}),e.jsxs("button",{type:"button",className:`rs-nav-btn next ${R?"":"dis"}`,onClick:()=>b(1),disabled:!R,children:[e.jsx("span",{className:"lbl",children:R?.timeLabel??""}),e.jsx("span",{className:"arr",children:"›"})]})]})]})]})}export{ee as MurmurPage};
